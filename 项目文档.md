🎼 TTML 歌词生成器项目文档

🧱 项目简介

本项目旨在构建一个专业的歌词制作工具，支持将歌词数据渲染为符合 Apple Music TTML 标准的文件。它包含：

- TTML 渲染器（使用 Jinja2）
- 歌词时间戳标注播放器（支持波形图、快捷键控制）
- 自动生成 itunes:key
- 支持角色标记（主唱、背景人声、对唱等）
- 支持主流音频格式（MP3, WAV, FLAC, AAC, M4A, OGG）

---

📦 项目结构

`plaintext ttml_generator/ ├── templates/ │   └── lyric_block.xml.j2      # Jinja2 模板（支持角色标记） ├── output/                     # 生成的 TTML 文件 ├── backup/                     # 自动备份副本 ├── main.py                     # 主程序入口 ├── renderer.py                 # 模板渲染器 ├── utils.py                    # 工具函数 ├── file_manager.py             # 文件读写模块 ├── audio_player/ │   ├── player_gui.py           # 播放器主界面（支持快捷键） │   ├── waveform.py             # 波形图生成与绘制 │   └── timestamp_manager.py    # 管理时间戳与歌词绑定 `

---

🧠 模块说明


| 文件名               | 功能描述                             |
| -------------------- | ------------------------------------ |
| main.py              | 程序入口，组织流程，调用各模块       |
| renderer.py          | 使用 Jinja2 渲染歌词模板             |
| utils.py             | 生成 key、校验时间戳、格式化歌词     |
| file_manager.py      | 保存 TTML 文件并自动备份             |
| player_gui.py        | 播放器界面，支持播放控制与时间戳标注 |
| waveform.py          | 提取音频能量并绘制波形图             |
| timestamp_manager.py | 管理歌词与时间戳绑定，导出结构化数据 |

---

🎼 歌词标注播放器功能

✅ 快捷键控制


| 键位  | 功能描述                     |
| ----- | ---------------------------- |
| SPACE | 播放 / 暂停切换              |
| [     | 减速播放（如 1.0x → 0.75x） |
| ]     | 加速播放（如 1.0x → 1.25x） |
| F     | 记录当前时间为乐句开始时间   |
| G     | 记录当前时间为乐句结束时间   |

✅ 播放器功能清单

- 播放 / 暂停
- 变速播放（0.5x ~ 2.0x）
- 拖动进度条跳转
- 显示波形图（带扫描线）
- 记录时间戳并绑定歌词
- 导出为结构化数据（用于 TTML 渲染）

---

🎧 支持的音频格式


| 格式  | 描述                          |
| ----- | ----------------------------- |
| .mp3  | 最常见的压缩音频格式          |
| .wav  | 无损格式，适合精确标注        |
| .flac | 高质量无损压缩格式            |
| .aac  | Apple 常用格式                |
| .ogg  | 开源格式，部分平台使用        |
| .m4a  | iTunes / Apple Music 常见格式 |

> 使用 pydub 加载音频，底层依赖 ffmpeg，需安装一次即可支持所有格式。

---

🧾 歌词数据结构示例

`python lyrics = [ {"text": "你好，世界", "start": "00:10.000", "end": "00:12.500", "role": "x-duet-a"}, {"text": "我一直在等你", "start": "00:12.500", "end": "00:15.000", "role": "x-duet-b"}, {"text": "(Held)", "start": "00:15.000", "end": "00:16.000", "role": "x-bg"}, {"text": "主唱段落", "start": "00:16.000", "end": "00:18.000"}  # 默认主唱 ] `

---

🧩 Jinja2 模板示例 lyric_block.xml.j2

`xml

<?xml version="1.0" encoding="UTF-8"?>

<tt xmlns="http://www.w3.org/ns/ttml"
xmlns:ttm="http://www.w3.org/ns/ttml#metadata"
xmlns:tts="http://www.w3.org/ns/ttml#styling">

<body>
    <div>
      {% for line in lyrics %}
      {% if line.role %}
      <span ttm:role="{{ line.role }}">
        <span begin="{{ line.start }}" end="{{ line.end }}">{{ line.text }}</span>
      </span>
      {% else %}
      <p begin="{{ line.start }}" end="{{ line.end }}" itunes:key="{{ line.key }}">
        {{ line.text }}
      </p>
      {% endif %}
      {% endfor %}
    </div>
  </body>
</tt>
`

---

📘 TTML 标准规范（W3C）

TTML（Timed Text Markup Language）是 W3C 制定的 XML 标准，用于表示带时间信息的文本内容。

✅ 核心元素说明


| 元素/属性   | 说明                                                |
| ----------- | --------------------------------------------------- |
| <tt>        | 根元素，包含所有 TTML 内容                          |
| xmlns       | 命名空间，必须包含 TTML、TTM（元数据）、TTS（样式） |
| <head>      | 元信息与样式定义区域                                |
| <body>      | 正文区域，包含字幕或歌词内容                        |
| <div>       | 内容容器，可包含多个<p> 或 <span>                   |
| <p>         | 一段文本，带时间戳与样式                            |
| <span>      | 可嵌套文本，支持角色标记与逐字控制                  |
| begin / end | 时间戳，格式为 hh:mm:ss.mmm                         |
| style       | 引用样式 ID（在<styling> 中定义）                   |
| ttm:role    | 角色标记，如 x-bg（背景人声）、x-duet-a（对唱 A）等 |

✅ Apple 扩展角色标记（非官方但广泛使用）


| 标记值      | 用途说明               |
| ----------- | ---------------------- |
| x-bg        | 背景人声（Background） |
| x-duet-a    | 对唱角色 A             |
| x-duet-b    | 对唱角色 B             |
| x-narration | 旁白、对白             |

⚠️ 注意事项

- 时间戳必须升序排列，不能重叠
- 时间格式为 hh:mm:ss.mmm
- 所有样式 ID 必须唯一
- 所有角色标记必须使用 ttm:role 命名空间
- 推荐使用 UTF-8 编码，扩展名为 .ttml

📖 官方规范：W3C TTML1 Recommendation

---

🚀 使用流程

1. 安装依赖

`bash pip install jinja2 pydub simpleaudio matplotlib `

并安装 ffmpeg：

- Windows：下载并配置环境变量
- macOS：brew install ffmpeg
- Linux：sudo apt install ffmpeg

---

2. 标注歌词时间戳

- 运行 player_gui.py
- 加载音频文件
- 使用快捷键标注每句歌词的开始与结束时间
- 导出为结构化数据（JSON 或 Python 字典）

---

3. 渲染 TTML 文件

- 将标注好的歌词数据传入 main.py
- 自动生成 TTML 文件并保存到 output/
- 自动备份到 backup/

---

🔮 可扩展功能（预留）

- 拖拽加载音频文件
- GUI 歌词编辑器
- 批量处理歌词文件
- 自动对齐歌词与音频（未来可选）

---

如果你希望我将这份文档导出为 Markdown 文件或嵌入到项目代码中，我可以帮你格式化。是否需要我生成一个示例项目压缩包结构

当然可以，km！以下是你在整个对话中提出的所有关键需求的系统性整理，分为功能模块、技术要求、设计规范和扩展方向。你可以将这份清单作为项目开发的蓝图或任务列表。

---

✅ TTML 歌词生成器项目需求总览

🎯 项目目标

构建一个专业的歌词制作工具，支持：

- 歌词时间戳标注（逐句）
- TTML 文件生成（符合 Apple Music 标准）
- 背景人声、对唱、角色标记
- 音频播放与波形图辅助标注
- 快捷键控制与高效标注流程
- 主流音频格式兼容

---

🧱 功能模块需求

1. TTML 渲染器

- 使用 Jinja2 模板引擎
- 自动生成 <p> 和 <span> 标签
- 支持 itunes:key 自动编号
- 支持 ttm:role 标记（如 x-bg, x-duet-a, x-duet-b）
- 输出符合 TTML1 标准的 .ttml 文件

2. 歌词标注播放器

- 播放音频文件（MP3, WAV, FLAC, AAC, M4A, OGG）
- 支持播放、暂停、变速（0.5x–2.0x）
- 支持进度条跳转
- 显示波形图（带扫描线）
- 快捷键控制：
  - SPACE：播放 / 暂停
  - [ / ]：减速 / 加速
  - F / G：记录开始 / 结束时间
- 自动绑定时间戳到歌词句
- 导出结构化歌词数据（JSON 或 Python 字典）

3. 文件管理模块

- 保存 TTML 文件到 output/
- 自动备份到 backup/（带时间戳）
- 支持文件命名规范（如 songname_YYYYMMDD.ttml）

4. 工具函数模块

- 自动生成 itunes:key（如 L1、L2…）
- 校验时间戳格式（hh:mm:ss.mmm）
- 格式化时间、歌词文本
- 支持角色字段处理（主唱、背景、对唱）

---

📘 技术规范要求

TTML 文件标准（W3C TTML1）

- 使用命名空间：xmlns, ttm, tts
- 时间戳格式：hh:mm:ss.mmm
- 标签结构：<tt> → <head> + <body> → <div> → <p>/<span>
- 支持样式定义（如 tts:fontSize, tts:color）
- 支持角色标记：ttm:role="x-bg", x-duet-a, x-duet-b

Apple Music 扩展支持

- 背景人声：ttm:role="x-bg"
- 对唱角色：x-duet-a, x-duet-b
- 旁白对白：x-narration
- 翻译与音译结构（可选）

---

🧩 模板设计要求

- 使用 Jinja2 模板文件（如 lyric_block.xml.j2）
- 支持条件渲染（主唱 vs 角色标记）
- 支持嵌套 <span> 结构
- 可扩展翻译、样式、动画字段

---

🎧 音频支持要求

- 使用 pydub 加载音频（自动识别格式）
- 使用 simpleaudio 或 pygame 播放音频
- 使用 matplotlib 绘制波形图
- 使用 ffmpeg 实现格式兼容（需安装）

---

📦 项目结构建议

`plaintext ttml_generator/ ├── templates/ │   └── lyric_block.xml.j2 ├── output/ ├── backup/ ├── main.py ├── renderer.py ├── utils.py ├── file_manager.py ├── audio_player/ │   ├── player_gui.py │   ├── waveform.py │   └── timestamp_manager.py `

---

🔮 可扩展方向（未来）

- 拖拽加载音频文件
- GUI 歌词编辑器（逐句输入）
- 批量处理歌词文件
- 自动对齐歌词与音频（节拍分析）
- 导出为 LRC、SRT、ASS 等其他格式

---

🎼 项目方案文档：TTML 歌词生成与编辑工具

🧩 项目目标

构建一个支持多格式歌词编辑、转换与导出的工具，核心功能包括：

- TTML 歌词生成与渲染
- 多角色标记与时间戳支持
- 文件读取与格式转换（TTML ↔ LRC）
- 剪贴板交互（导入与导出）
- 可视化编辑与导出

---

📁 功能模块概览


| 模块名称       | 功能描述                                                |
| -------------- | ------------------------------------------------------- |
| TTML 渲染模块  | 根据歌词数据结构生成标准 TTML 文件                      |
| 多角色支持模块 | 支持角色标记（如 x-bg、x-fg），用于区分不同角色或演唱者 |
| 时间戳处理模块 | 支持逐句或逐字时间戳，自动计算持续时间                  |
| 文件读取模块   | 读取 TTML 和 LRC 文件，解析为统一数据结构               |
| 文件转换模块   | 实现 TTML ↔ LRC 双向转换                               |
| 剪贴板交互模块 | 从剪贴板读取歌词文本或时间戳，或将生成内容导出到剪贴板  |
| 可视化编辑模块 | 提供 GUI 或 Web 界面进行歌词编辑与格式转换（可选扩展）  |

---

🧠 技术实现细节

1. TTML 文件读取与修改

- 使用 xml.etree.ElementTree 或 lxml 解析 .ttml 文件
- 提取 <p> 和 <span> 标签中的：
  - 文本内容
  - 时间戳（begin, end）
  - 角色标记（style）
  - 唯一标识（xml:id）
- 修改后重新生成 TTML 文件，保持结构规范

2. LRC 文件读取与解析

- 使用正则表达式解析 [mm:ss.xx]歌词内容 格式
- 支持逐句时间戳（标准 LRC）或逐字时间戳（增强格式）
- 转换为统一歌词数据结构，便于后续处理

3. 文件格式转换模块

📌 TTML → LRC

- 提取时间戳与文本内容
- 格式化为 [mm:ss.xx]歌词 格式
- 可选保留角色信息为注释或标签

📌 LRC → TTML

- 解析时间戳与歌词
- 自动生成 <p> 标签，嵌套 <span>（如逐字时间戳）
- 可选添加角色标记与样式

4. 剪贴板交互支持

- 使用 pyperclip 实现跨平台剪贴板读写

📥 从剪贴板读取

`python
import pyperclip

text = pyperclip.paste()

可解析为歌词数据结构
`

📤 导出到剪贴板

`python
pyperclip.copy(ttml_content)

可直接粘贴到文本编辑器或网页
`

- 支持导入纯文本歌词、LRC 格式、TTML 片段
- 支持导出完整 TTML 或 LRC 内容

---

📦 项目结构建议

`plaintext ttml_generator/ ├── convert/ │   ├── ttmltolrc.py │   ├── lrctottml.py ├── clipboard/ │   ├── import_clipboard.py │   └── export_clipboard.py ├── parser/ │   ├── ttml_parser.py │   └── lrc_parser.py ├── renderer/ │   └── ttml_renderer.py `

---

🧬 数据结构统一规范

所有歌词格式解析后统一转换为以下结构：

`python lyrics = [ { "text": "歌词内容", "start": "00:01.000", "end": "00:03.000", "role": "x-bg",  # 可选 "key": "L1"      # 可选 }, ... ] `

- 便于渲染 TTML、生成 LRC、编辑或剪贴板交互
- 可扩展支持逐字时间戳与角色样式

---

📘 文档章节更新建议

新增以下文档章节：

- ✅ 文件读取与解析（TTML / LRC）
- ✅ 文件格式转换（双向）
- ✅ 剪贴板交互说明
- ✅ 数据结构统一规范
- ✅ 示例转换命令与代码片段

---

📐 项目方案文档更新：格式标准与规范支持

📘 支持的格式标准

本项目严格遵循以下公开标准，以确保生成的歌词文件具备良好的兼容性和可移植性：

1. TTML 标准（Timed Text Markup Language）

- 参考规范：W3C TTML1 / TTML2
- 核心标签：
  - <tt>：根元素
  - <body> → <div> → <p>：文本结构层级
  - <span>：用于嵌套时间戳或角色样式
- 时间格式：
  - 精确到毫秒，如 "00:01.500"
  - 支持 begin / end 或 dur 属性
- 样式支持：
  - 使用 style 属性引用样式定义（如角色颜色、字体）
  - 可扩展为 TTML + CSS 或 TTML + Styling Profiles

示例片段：

`xml

<p xml:id="L1" begin="00:01.000" end="00:03.000" style="x-bg">
  <span begin="00:01.000">你</span>
  <span begin="00:01.500">好</span>
</p>
`

---

2. LRC 标准（LyRiCs Format）

- 参考规范：ID3v2 LRC 标准扩展
- 时间戳格式：
  - [mm:ss.xx]，如 [01:23.45]
  - 支持逐句或逐字时间戳（增强格式）
- 内容格式：
  - 每行一个时间戳与歌词内容
  - 可包含元信息标签，如 [ar:歌手], [ti:标题], [al:专辑]

示例片段：

`lrc [00:01.00]你 [00:01.50]好 `

---

3. 剪贴板内容规范

- 支持以下内容格式从剪贴板导入：
  - 纯文本歌词（自动分行）
  - LRC 格式文本（自动解析时间戳）
  - TTML 片段（自动解析 XML）
- 导出内容格式：
  - 可选导出为纯文本、LRC 或 TTML
  - 保证格式完整性与可粘贴性

---

📑 标准兼容性说明


| 格式   | 兼容平台/工具                          | 说明                                     |
| ------ | -------------------------------------- | ---------------------------------------- |
| TTML   | YouTube 字幕、Netflix、VLC、字幕编辑器 | 支持多语言、样式、角色标记，适合复杂字幕 |
| LRC    | 音乐播放器（如网易云、Foobar2000）     | 简洁轻量，适合歌词同步显示               |
| 剪贴板 | 文本编辑器、网页、歌词平台             | 快速交互，便于复制粘贴                   |

---

📌 标准扩展建议（可选）

- 支持 TTML2 的高级功能，如：
  - 区域定位（字幕位置）
  - 动态样式切换
  - 多语言字幕切换
- 支持增强型 LRC：
  - 多时间戳支持
  - 逐字同步
  - 自定义标签扩展

---

✅ 文档结构更新建议

新增章节：

- 📘 格式标准支持（TTML / LRC / 剪贴板）
- 📑 标准兼容性说明
- 📌 标准扩展建议
